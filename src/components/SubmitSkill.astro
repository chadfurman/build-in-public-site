---
// Submit a Skill CTA — Web3Forms with client-side validation
const WEB3FORMS_KEY = 'e391d45f-dab1-447a-a26e-0a300e76551d';
---

<section class="submit-skill">
  <div class="submit-inner">
    <div class="submit-icon" aria-hidden="true">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <rect x="4" y="4" width="24" height="24" rx="4" stroke="currentColor" stroke-width="1.5"/>
        <path d="M16 10v12M10 16h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </div>
    <h3>Submit a skill</h3>
    <p>Have a Claude Code skill? Submit your SKILL.md URL and we'll add it to the audit queue.</p>

    <form class="submit-form" id="submit-skill-form" data-key={WEB3FORMS_KEY}>
      <input type="hidden" name="access_key" value={WEB3FORMS_KEY} />
      <input type="hidden" name="subject" value="New Skill Submission" />
      <input type="hidden" name="from_name" value="Build Aloud Skill Submission" />
      <input type="checkbox" name="botcheck" class="hidden" style="display:none" />
      <div class="input-wrapper">
        <span class="input-prefix" aria-hidden="true">&gt;</span>
        <input
          type="url"
          name="url"
          id="skill-url"
          placeholder="https://github.com/user/repo/blob/main/SKILL.md"
          required
          autocomplete="url"
        />
      </div>
      <button type="submit" id="submit-btn">
        Submit
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
          <path d="M3 7h8M8 4l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </form>

    <div class="submit-status" id="submit-status" aria-live="polite"></div>
    <p class="submit-hint" id="submit-hint">URL must point to a SKILL.md file</p>
  </div>
</section>

<script>
  const form = document.getElementById('submit-skill-form') as HTMLFormElement;
  const urlInput = document.getElementById('skill-url') as HTMLInputElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const status = document.getElementById('submit-status') as HTMLDivElement;
  const hint = document.getElementById('submit-hint') as HTMLParagraphElement;

  const RATE_LIMIT_COOKIE = 'skill_submit_cooldown';
  const COOLDOWN_MS = 5 * 60 * 1000;

  function getCookie(name: string): string | null {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
  }

  function setCooldownCookie() {
    const expires = new Date(Date.now() + COOLDOWN_MS).toUTCString();
    document.cookie = `${RATE_LIMIT_COOKIE}=1; expires=${expires}; path=/; SameSite=Lax`;
  }

  function isOnCooldown(): boolean {
    return getCookie(RATE_LIMIT_COOKIE) !== null;
  }

  function showStatus(msg: string, type: 'success' | 'error' | 'loading') {
    status.textContent = msg;
    status.className = `submit-status ${type}`;
    status.style.display = 'block';
    hint.style.display = 'none';
  }

  function resetStatus() {
    status.style.display = 'none';
    status.textContent = '';
    hint.style.display = '';
  }

  function validateUrl(url: string): boolean {
    try {
      const parsed = new URL(url);
      return parsed.pathname.endsWith('SKILL.md') && (parsed.protocol === 'https:' || parsed.protocol === 'http:');
    } catch {
      return false;
    }
  }

  function getRawUrl(url: string): string {
    // Convert GitHub blob URLs to raw URLs for fetch validation
    const ghMatch = url.match(/^https:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/(.+)$/);
    if (ghMatch) {
      return `https://raw.githubusercontent.com/${ghMatch[1]}/${ghMatch[2]}/${ghMatch[3]}`;
    }
    return url;
  }

  // Live validation on input
  urlInput.addEventListener('input', () => {
    const val = urlInput.value.trim();
    if (val && !validateUrl(val)) {
      urlInput.setCustomValidity('URL must end with SKILL.md');
    } else {
      urlInput.setCustomValidity('');
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Rate limit check
    if (isOnCooldown()) {
      showStatus('Easy there — wait 5 minutes before submitting another skill.', 'error');
      return;
    }

    const url = urlInput.value.trim();

    // Client-side URL validation
    if (!validateUrl(url)) {
      showStatus('URL must point to a SKILL.md file.', 'error');
      return;
    }

    // Disable form while processing
    submitBtn.disabled = true;
    urlInput.disabled = true;
    showStatus('Checking skill...', 'loading');

    // Client-side reachability check
    try {
      const rawUrl = getRawUrl(url);
      const res = await fetch(rawUrl, { method: 'HEAD', mode: 'no-cors' });
      // no-cors means we can't read the status, but if fetch itself throws, the URL is unreachable
    } catch {
      showStatus('Could not reach that URL. Double-check it and try again.', 'error');
      submitBtn.disabled = false;
      urlInput.disabled = false;
      return;
    }

    // Submit to Web3Forms
    try {
      const formData = new FormData(form);
      const res = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData,
      });
      const data = await res.json();

      if (data.success) {
        setCooldownCookie();
        showStatus('Thanks! We\'ll queue it for audit.', 'success');
        urlInput.value = '';
      } else {
        showStatus('Something went wrong. Try again later.', 'error');
      }
    } catch {
      showStatus('Network error. Try again later.', 'error');
    }

    submitBtn.disabled = false;
    urlInput.disabled = false;
  });

  // Check cooldown on page load
  if (isOnCooldown()) {
    hint.textContent = 'You recently submitted a skill — wait a few minutes before submitting another.';
  }
</script>

<style>
  .submit-skill {
    max-width: var(--max-width);
    margin: 2rem auto 0;
    padding: 0 var(--gutter);
    animation: fadeUp 0.7s ease both;
  }

  .submit-inner {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    padding: 2.5rem 2rem;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .submit-inner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--color-hot), transparent);
    opacity: 0.3;
  }

  .submit-icon {
    color: var(--color-hot, var(--color-accent));
    margin-bottom: 1rem;
    opacity: 0.7;
  }

  .submit-inner h3 {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 0.5rem;
    color: var(--color-text);
  }

  .submit-inner p {
    color: var(--color-text-secondary);
    margin: 0 0 1.5rem;
    font-size: 0.9rem;
    max-width: 22rem;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.5;
  }

  .submit-form {
    display: flex;
    gap: 0.5rem;
    max-width: 32rem;
    margin: 0 auto;
  }

  .input-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.4rem;
    padding-left: 0.75rem;
    transition: border-color 0.2s ease;
  }

  .input-wrapper:focus-within {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 2px var(--color-accent-dim);
  }

  .input-prefix {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--color-accent);
    opacity: 0.5;
    margin-right: 0.25rem;
    user-select: none;
  }

  .submit-form input[type='url'] {
    flex: 1;
    padding: 0.65rem 0.5rem;
    border: none;
    background: transparent;
    font-family: var(--font-mono);
    font-size: 0.82rem;
    color: var(--color-text);
    outline: none;
    min-width: 0;
  }

  .submit-form input[type='url']::placeholder {
    color: var(--color-muted);
    opacity: 0.6;
  }

  .submit-form button {
    padding: 0.65rem 1.25rem;
    background: var(--color-accent);
    color: var(--color-bg);
    border: none;
    border-radius: 0.4rem;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    transition: transform 0.15s ease, box-shadow 0.2s ease;
    white-space: nowrap;
  }

  .submit-form button:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(163, 247, 191, 0.2);
  }

  .submit-form button:active:not(:disabled) {
    transform: translateY(0);
  }

  .submit-form button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .submit-hint {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-muted);
    margin-top: 0.75rem;
    opacity: 0.6;
  }

  .submit-status {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    margin-top: 0.75rem;
    display: none;
  }

  .submit-status.success {
    color: var(--color-accent);
  }

  .submit-status.error {
    color: var(--color-hot, #ff6b6b);
  }

  .submit-status.loading {
    color: var(--color-muted);
  }

  @media (max-width: 480px) {
    .submit-form {
      flex-direction: column;
    }

    .submit-inner {
      padding: 2rem 1.25rem;
    }
  }
</style>
